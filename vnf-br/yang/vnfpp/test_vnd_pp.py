import unittest
import vnf_pp as vnf_pp
import yaml
import os
import pyangbind.lib.pybindJSON as pybindJSON

MODEL_NAME = "vnf_pp"
EXAMPLE_DIR = "examples/"


def check_against_model(yaml_path):
    """
    Open a given YAML file and tries to load it into
    model that was generated by pyangbind.
    Fails if the YAML file is not compatible to the
    model.
    """
    with open(yaml_path, "r") as f:
        vnf_pp_data = yaml.load(f)
        vnf_pp_model = pybindJSON.loads_ietf(
            vnf_pp_data, vnf_pp, MODEL_NAME)
        #  print(ped_model.ped.name)  # example how to use model
        return vnf_pp_model


class TestStringMethods(unittest.TestCase):

    def test_example_vnf_pps_against_model(self):
        # collect all example vnf_pp files which should be checked against model
        example_vnf_pps = os.listdir(EXAMPLE_DIR)
        # check each vnf_pp file against the model
        print("Validating: {} VNF-PP files.".format(len(example_vnf_pps)))
        for ep in example_vnf_pps:
            self.assertIsNotNone(
                check_against_model(os.path.join(EXAMPLE_DIR, ep)))
            print("File: '{}' is valid against model '{}'."
                .format(ep, MODEL_NAME))

    def test_example_vnf_pps_dump_json(self):
        example_vnf_pps = os.listdir(EXAMPLE_DIR)
        # check each vnf_pp file against the model
        print("Validating: {} VNF-PP files.".format(len(example_vnf_pps)))
        for ep in example_vnf_pps:
            parsed_vnfpp = check_against_model(os.path.join(EXAMPLE_DIR, ep))
            print(pybindJSON.dumps(parsed_vnfpp))
